 pipeline {
    agent any
    tools{
        nodejs "18.1.0"
    }
    stages{
        stage("build") {
            steps {
                dir('INO/GCL01/MK402568/Lab05') {
                echo "building.." 
				   sh 'docker build . -f dockerfileBuild.dockerfile -t builder'
                }
            }
        }
        stage('test') {
            steps {
                 dir('INO/GCL01/MK402568/Lab05') {
                    sh 'docker build . -f dock2.dockerfile -t tester'
                    sh' docker run tester'
                }
            }
        }
         stage('deploy') {
            steps {
               echo 'deploying..'
                 
				  sh 'docker run --volume /var/jenkins_home/workspace/volumes:/finalBuild builder mv -n build /finalBuild '
				  echo 'building image..'
                  dir('INO/GCL01/MK402568/Lab05') {
                    sh 'docker build . -f dockerfileDeploy.dockerfile -t deploy'
                  }
					sh 'docker stop $(docker ps -a -q)'
					//sh 'docker rmi -f $(docker images -aq)'
					sh 'docker run --volume /var/jenkins_home/workspace/volumes/build:/build -d -p 3000:80 deploy'
					
            }
        }
        stage('publish') {
            steps {
               echo "publishing.."
               dir('INO/GCL01/MK402568/Lab05') {
			    sh 'docker build . -f dockerfilePublish.dockerfile -t publish'
               }
				sh "docker run --volume /var/jenkins_home/workspace/volumes:/final publish mv nodejs.tar.xz /final"
			
            }
        }
    }
}